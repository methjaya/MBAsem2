<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBA Library - Peradeniya University</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- Header Section -->
    <header class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 mb-8 text-center md:text-left">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-2">MBA Library</h1>
        <p class="text-lg text-gray-600">Peradeniya University - Semester 2</p>
        <p class="text-sm text-gray-500 mt-1">Created by Sahansa Jayawardhana</p>
    </header>

    <!-- Main Content Container -->
    <main class="w-full max-w-4xl flex flex-col gap-6">

        <!-- Module Navigation and Content Area Tile -->
        <div class="w-full bg-white rounded-xl shadow-lg p-6 flex flex-col md:flex-row gap-6">

            <!-- Module Navigation Sidebar -->
            <nav class="w-full md:w-1/3 flex flex-col space-y-4">
                <button id="btn-mm" onclick="showModule('mm')" class="module-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 duration-200 ease-in-out">
                    MM - Marketing Management MGT 5201
                </button>
                <button id="btn-hrm" onclick="showModule('hrm')" class="module-btn bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 duration-200 ease-in-out">
                    HRM - Human Resource Management MGT 5202
                </button>
                <button id="btn-om" onclick="showModule('om')" class="module-btn bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 duration-200 ease-in-out">
                    OM - Operations Management MGT 5203
                </button>
                <button id="btn-ob" onclick="showModule('ob')" class="module-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 duration-200 ease-in-out">
                    OB - Organizational Behaviour MGT 5204
                </button>
            </nav>

            <!-- Module Content Area -->
            <div id="content-area" class="w-full md:w-2/3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <!-- Welcome and Loading Messages -->
                <div id="status-message" class="text-center p-8">
                    <p class="text-gray-500 text-lg">Loading...</p>
                </div>
                
                <!-- Dynamic Lesson Lists -->
                <div id="mm-content" class="module-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">MM / Marketing Management MGT 5201</h2>
                    <ul id="mm-list" class="list-none space-y-2 text-gray-700"></ul>
                </div>
                <div id="hrm-content" class="module-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">HRM / Human Resource Management MGT 5202</h2>
                    <ul id="hrm-list" class="list-none space-y-2 text-gray-700"></ul>
                </div>
                <div id="om-content" class="module-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">OM / Operations Management MGT 5203</h2>
                    <ul id="om-list" class="list-none space-y-2 text-gray-700"></ul>
                </div>
                <div id="ob-content" class="module-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">OB / Organizational Behaviour MGT 5204</h2>
                    <ul id="ob-list" class="list-none space-y-2 text-gray-700"></ul>
                </div>
            </div>
        </div>

    </main>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Deletion</h3>
            <p id="delete-confirm-text" class="text-gray-700 mb-6">Are you sure you want to delete this lesson?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 duration-200 ease-in-out">
                    Delete
                </button>
                <button id="cancel-delete-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 duration-200 ease-in-out">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, addDoc, deleteDoc, doc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration and initialization (MANDATORY)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db;
        let auth;
        let userId;
        let unsubscribeListeners = {};

        const statusMessage = document.getElementById('status-message');
        const moduleLists = {
            'mm': document.getElementById('mm-list'),
            'hrm': document.getElementById('hrm-list'),
            'om': document.getElementById('om-list'),
            'ob': document.getElementById('ob-list')
        };
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        
        const initialLessons = {
            'mm': [
                "Lesson 01 - Introduction to marketing management",
                "Lesson 02 - Analyzing the marketing environment",
                "Lesson 03 - Marketing research and Analytics",
                "Lesson 04 - Consumer behaviour PG",
                "Lesson 05 - Business market and industrial buying behavior",
                "Lesson 06 - Addressing competition and driving growth",
                "Lesson 07 - Market segmentation, targeting and positioning",
                "Lesson 08 - Developing product strategy",
                "Lesson 09 - Part 1: Pricing",
                "Lesson 10 - Part 2: Place",
                "Lesson 11 - Designing and managing integrated marketing communications",
                "Lesson 12 - Designing and managing services",
                "Lesson 13 - Ethics and social responsibility in marketing",
                "Lesson 14 - International marketing strategy"
            ],
            'hrm': [
                "Lesson 01 - Introduction to HRM",
                "Lesson 02 - Strategic Human Resource Management",
                "Lesson 03 - Alignment Between Business Strategy and HR Strategy",
                "Lesson 04 Part 1 - Job Design, Analysis & Description",
                "Lesson 04 Part 2 - Human Resource Planning",
                "Lesson 05 - Contemporary Human Resource Practices",
                "Lesson 06 Part 01 - Recruitment",
                "Lesson 06 Part 02 - Selection",
                "Lesson 07 - Alternative Resourcing Strategies",
                "Lesson 08 Part 01 - Training, Development, and Learning",
                "Lesson 08 Part 02 - Learning and New Learning Approaches",
                "Lesson 08 Part 03 - Career Management",
                "Lesson 09 - Effective Questioning Techniques",
                "Lesson 10 - Performance Management",
                "Lesson 11 - New Learning Needs and Approaches",
                "Lesson 12 - Applicability of Theories and Practices",
                "Lesson 13 - Compensation and Reward Management",
                "Lesson 13 Part 01 - Compensation and Rewards",
                "Lesson 13 Part 02 - Compensation and Reward Systems",
                "Lesson 13 Part 03 - Compensation and Reward Practices",
                "Lesson 14 - Compensation and Reward Strategies",
                "Lesson 15 - Discipline Management"
            ],
            'om': [
                "Lesson 01 Introduction to Operations Management",
                "Lesson 02 Operations Strategy, Competitiveness and Productivity",
                "Lesson 03 Capacity Planning for Products and Services",
                "Lesson 04 Product Design and Service Design",
                "Lesson 05 Job Design and Work Measurement",
                "Lesson 06 Process Design and Layout Design",
                "Lesson 07 Location Analysis",
                "Lesson 08 Quality Management",
                "Lesson 09 Inventory Management",
                "Lesson 10 ERP and MRP (OM)",
                "Lesson 11 Supply Chain Management",
                "Lesson 15 Sustainable Manufacturing"
            ],
            'ob': [
                "Lesson 01 Introduction to Organizational Behavior",
                "Lesson 02 Perception",
                "Lesson 03 Personality",
                "Lesson 04 Work-Related Attitudes and Psychological Contract",
                "Lesson 05 Learning",
                "Lesson 06 Motivating People Theory and Application",
                "Lesson 07 Diversity, Equity and Inclusion in Organizations",
                "Lesson 08 Leadership",
                "Lesson 09 Groups and Teams at Workplace",
                "Lesson 10 Conflict Management and Negotiation",
                "Lesson 14-15 Organizational Change Management"
            ]
        };

        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;
                if (__initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        statusMessage.textContent = 'User authenticated. Ready to use.';
                        populateDatabaseWithInitialLessons();
                        setupRealtimeListeners();
                    } else {
                        statusMessage.textContent = 'Authentication failed. Please try again.';
                        console.error('Authentication failed.');
                    }
                });

            } catch (e) {
                statusMessage.textContent = 'Error initializing Firebase.';
                console.error("Error initializing Firebase:", e);
            }
        };

        const populateDatabaseWithInitialLessons = async () => {
            const lessonsRef = collection(db, `artifacts/${appId}/public/data/lessons`);
            const lessonsSnapshot = await getDocs(lessonsRef);
            if (lessonsSnapshot.empty) {
                console.log("Populating database with initial lessons...");
                for (const moduleId in initialLessons) {
                    for (const lessonName of initialLessons[moduleId]) {
                        try {
                            await addDoc(lessonsRef, {
                                moduleId: moduleId,
                                lessonName: lessonName,
                                pdfUrl: '#', // Placeholder URL
                                createdAt: serverTimestamp()
                            });
                        } catch (e) {
                            console.error("Error adding initial document:", e);
                        }
                    }
                }
            } else {
                console.log("Database already populated. Skipping initial population.");
            }
        };

        const setupRealtimeListeners = () => {
            for (const moduleId in moduleLists) {
                const moduleRef = collection(db, `artifacts/${appId}/public/data/lessons`);
                const q = query(moduleRef, where('moduleId', '==', moduleId));
                
                // Unsubscribe from previous listener if it exists
                if (unsubscribeListeners[moduleId]) {
                    unsubscribeListeners[moduleId]();
                }

                // Setup new listener
                unsubscribeListeners[moduleId] = onSnapshot(q, (snapshot) => {
                    const lessons = [];
                    snapshot.forEach(doc => {
                        lessons.push({ id: doc.id, ...doc.data() });
                    });
                    renderLessons(moduleId, lessons);
                }, (error) => {
                    console.error("Error getting real-time updates:", error);
                    moduleLists[moduleId].innerHTML = '<li class="text-red-500">Error loading lessons.</li>';
                });
            }
        };

        const renderLessons = (moduleId, lessons) => {
            const lessonListElement = moduleLists[moduleId];
            lessonListElement.innerHTML = ''; // Clear existing list

            if (lessons.length === 0) {
                lessonListElement.innerHTML = '<li class="text-gray-500">No lessons uploaded yet for this module.</li>';
            } else {
                lessons.sort((a, b) => a.lessonName.localeCompare(b.lessonName));
                lessons.forEach(lesson => {
                    const li = document.createElement('li');
                    li.classList.add('flex', 'justify-between', 'items-center', 'p-2', 'rounded-lg', 'bg-gray-200', 'hover:bg-gray-300', 'transition-colors', 'duration-200');
                    li.innerHTML = `
                        <a href="${lesson.pdfUrl}" target="_blank" class="flex-grow hover:underline text-blue-600 font-medium">
                            ${lesson.lessonName}
                        </a>
                        <button onclick="showDeleteModal('${lesson.id}', '${lesson.lessonName}')" class="ml-4 text-red-500 hover:text-red-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    lessonListElement.appendChild(li);
                });
            }
        };
        
        // Expose functions to the global scope
        window.showModule = (moduleId) => {
            // Hide all module content divs
            const moduleDivs = document.querySelectorAll('.module-content');
            moduleDivs.forEach(div => {
                div.classList.add('hidden');
            });
            // Show the selected module's content div
            const selectedModule = document.getElementById(moduleId + '-content');
            selectedModule.classList.remove('hidden');

            // Hide status message
            statusMessage.classList.add('hidden');
        };

        window.showDeleteModal = (docId, lessonName) => {
            document.getElementById('delete-confirm-text').textContent = `Are you sure you want to delete "${lessonName}"?`;
            deleteModal.classList.remove('hidden');

            const confirmAction = () => {
                deleteLesson(docId);
                deleteModal.classList.add('hidden');
                confirmDeleteBtn.removeEventListener('click', confirmAction);
            };

            const cancelAction = () => {
                deleteModal.classList.add('hidden');
                cancelDeleteBtn.removeEventListener('click', cancelAction);
            };
            
            confirmDeleteBtn.addEventListener('click', confirmAction);
            cancelDeleteBtn.addEventListener('click', cancelAction);
        };

        window.deleteLesson = async (docId) => {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/lessons`, docId));
                console.log("Document successfully deleted!");
            } catch (e) {
                console.error("Error removing document: ", e);
            }
        };

        // Initialize on window load
        window.onload = initializeFirebase;
    </script>
</body>
</html>
